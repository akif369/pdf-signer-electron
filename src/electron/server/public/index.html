// server.js
import express from "express";
import { createServer } from "http";
import { Server } from "socket.io";
import fs from "fs";

let currentPdfBuffer = null;

export function startServer(onClientChange) {
  const app = express();
  const httpServer = createServer(app);
  const io = new Server(httpServer);

  const PORT = 3000;

  // Upload new PDF
  app.post(
    "/upload-pdf",
    express.raw({ type: "application/pdf", limit: "50mb" }),
    (req, res) => {
      if (!req.body || !req.body.length) {
        return res.status(400).send("No PDF uploaded");
      }
      currentPdfBuffer = req.body;
      io.emit("pdf-updated");
      console.log("📄 PDF uploaded and served");
      res.send("OK");
    }
  );

  // Serve current PDF
  app.get("/pdf", (req, res) => {
    if (!currentPdfBuffer) {
      return res.status(404).send("No PDF loaded");
    }
    res.contentType("application/pdf");
    res.send(currentPdfBuffer);
  });

  // Receive signed PDF back
  app.post(
    "/signed-pdf",
    express.raw({ type: "application/pdf", limit: "50mb" }),
    (req, res) => {
      fs.writeFileSync("signed_output.pdf", req.body); // save signed PDF
      console.log("✅ Signed PDF received and saved as signed_output.pdf");
      res.send("OK");
    }
  );

  // Signing page
  app.get("/", (req, res) => {
    res.sendFile(process.cwd() + "/public/sign.html");
  });

  io.on("connection", (socket) => {
    console.log("✅ Chrome page connected");
    onClientChange(true);

    socket.on("disconnect", () => {
      console.log("❌ Chrome page disconnected");
      onClientChange(false);
    });
  });

  httpServer.listen(PORT, () => {
    console.log(`🚀 Server running at http://localhost:${PORT}`);
  });
}
